<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×—.×¡×‘×Ÿ - ×§×˜×œ×•×’ ×—×›× (Freedom Edition)</title>
    
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuYXneXlueZl9ecIOXlueZl9ecIiwKICAic2hvcnRfbmFtZSI6ICLmF53l5bnmZfXnCIsKICAic3RhcnRfdXJsIjogIi4vaW5kZXguaHRtbCIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmZmZmZmYiLAogICJ0aGVtZV9jb2xvciI6ICIjMTRiOGE2IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9jZG4taWNvbnMtcG5nLmZsYXRpY29uLmNvbS81MTIvMjUvMjU2OTQucG5nIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXQp9">
    <meta name="theme-color" content="#14b8a6">

    <!-- Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/history@5/umd/history.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-router@6.3.0/umd/react-router.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-router-dom@6.3.0/umd/react-router-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <!-- PocketBase SDK -->
    <script src="https://unpkg.com/pocketbase/dist/pocketbase.umd.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { saban: { 500: '#14b8a6', 600: '#0d9488', 50: '#f0fdfa' } },
                    fontFamily: { sans: ['Heebo', 'sans-serif'] },
                    boxShadow: { 'up': '0 -4px 20px -2px rgba(0, 0, 0, 0.1)' }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.5); }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { HashRouter, Routes, Route, Link, useNavigate, useParams, useLocation } = ReactRouterDOM;
        const { motion, AnimatePresence } = window.Motion;

        // --- PocketBase Connection ---
        const PB_URL = 'http://127.0.0.1:8090'; // ×©× ×” ×œ-IP ×©×œ ×”×©×¨×ª ×©×œ×š ×× ×¦×¨×™×š
        const pb = new PocketBase(PB_URL);
        pb.autoCancellation(false);

        // --- Data Service Adapter (PB implementation) ---
        const DataService = {
            subscribeProducts: (cb) => {
                // Initial fetch
                pb.collection('products').getFullList({ sort: '-created' }).then(cb);
                // Realtime subscription
                pb.collection('products').subscribe('*', function(e) {
                    // For simplicity in this demo, we re-fetch all on change. 
                    // Optimized app would merge changes.
                    pb.collection('products').getFullList({ sort: '-created' }).then(cb);
                });
                return () => pb.collection('products').unsubscribe('*');
            },
            subscribeCategories: (cb) => {
                pb.collection('categories').getFullList().then(list => {
                    if(list.length === 0) cb([{id: 'all', name: '×”×›×œ', icon: 'LayoutGrid'}]);
                    else cb([{id: 'all', name: '×”×›×œ', icon: 'LayoutGrid'}, ...list]);
                });
            }
        };

        // --- 1. LOGIC ENGINES (From original file) ---
        const ProductAnalyzer = {
            analyze: (product) => {
                if (!product) return [];
                const insights = [];
                const specs = product.technicalSpecs || {};
                if (specs.standard) insights.push({ type: 'good', text: `×¢×•××“ ×‘×ª×§×Ÿ: ${specs.standard}`, icon: 'Award' });
                else insights.push({ type: 'warn', text: '×œ× ×¦×•×™×Ÿ ×ª×§×Ÿ ×¨×©××™', icon: 'AlertCircle' });
                if (specs.dryingTime && (specs.dryingTime.toString().includes('×©×¢×•×ª') || parseInt(specs.dryingTime) < 24)) {
                    insights.push({ type: 'info', text: '×–××Ÿ ×™×™×‘×•×© ××”×™×¨', icon: 'Clock' });
                }
                const desc = (product.description || '').toLowerCase();
                if (desc.includes('×—×•×¥') || desc.includes('×©××©') || desc.includes('××™×')) {
                    insights.push({ type: 'good', text: '××ª××™× ×œ×ª× ××™ ×—×•×¥', icon: 'Sun' });
                }
                return insights;
            },
            findAlternatives: (currentProduct, allProducts) => {
                if (!currentProduct || !allProducts) return [];
                return allProducts.filter(p => 
                    p.id !== currentProduct.id && 
                    p.category === currentProduct.category &&
                    Math.abs(p.price - currentProduct.price) < (currentProduct.price * 0.5)
                ).slice(0, 3);
            }
        };

        const SmartSearch = (query, products) => {
            if (!query) return products;
            const term = query.toLowerCase();
            return products.filter(p => {
                const titleMatch = (p.title || '').toLowerCase().includes(term);
                const skuMatch = (p.sku || '').toLowerCase().includes(term);
                const brandMatch = (p.brand || '').toLowerCase().includes(term);
                const descMatch = (p.description || '').toLowerCase().includes(term);
                return titleMatch || skuMatch || brandMatch || descMatch;
            });
        };

        // --- 2. UI COMPONENTS ---

        const Icon = ({ name, size = 20, className }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && window.lucide && window.lucide.icons[name]) {
                    const svg = window.lucide.createElement(window.lucide.icons[name]);
                    svg.setAttribute('width', size); svg.setAttribute('height', size);
                    if(className) svg.setAttribute('class', className);
                    ref.current.innerHTML = ''; ref.current.appendChild(svg);
                }
            }, [name, size, className]);
            return <span ref={ref} className="inline-flex items-center justify-center"/>;
        };

        const NavBar = ({ cartCount }) => {
            const loc = useLocation();
            const isActive = (p) => loc.pathname === p ? 'text-saban-600' : 'text-gray-400';
            return (
                <div className="fixed bottom-0 w-full bg-white glass pb-safe border-t z-30 h-16 flex justify-around items-center px-2">
                    <Link to="/" className={`flex flex-col items-center gap-1 text-[10px] font-medium ${isActive('/')}`}><Icon name="Home" size={22} /><span>×¨××©×™</span></Link>
                    <Link to="/scan" className="flex flex-col items-center justify-center -mt-6"><div className="bg-saban-600 text-white p-3.5 rounded-full shadow-lg"><Icon name="ScanLine" size={24} /></div><span className="text-[10px] font-bold text-saban-600 mt-1">×¡×¨×•×§</span></Link>
                    <Link to="/cart" className={`flex flex-col items-center gap-1 text-[10px] font-medium relative ${isActive('/cart')}`}><Icon name="ShoppingCart" size={22} />{cartCount > 0 && <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center">{cartCount}</span>}<span>×¢×’×œ×”</span></Link>
                </div>
            );
        };

        const ComparisonTable = ({ products, onClose }) => {
            if (products.length < 2) return null;
            const headers = [
                { key: 'price', label: '××—×™×¨' },
                { key: 'brand', label: '××•×ª×’' },
                { key: 'coverage', label: '×›×™×¡×•×™', path: 'technicalSpecs.coveragePerM2' },
                { key: 'drying', label: '×™×™×‘×•×©', path: 'technicalSpecs.dryingTime' },
                { key: 'standard', label: '×ª×§×Ÿ', path: 'technicalSpecs.standard' }
            ];
            const getValue = (p, path) => {
                if (!path) return p[path];
                return path.split('.').reduce((o, i) => o ? o[i] : null, p) || '-';
            };
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-end justify-center sm:items-center p-4 animate-in fade-in">
                    <div className="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b flex justify-between items-center bg-gray-50">
                            <h3 className="font-bold text-lg">×”×©×•×•××ª ××•×¦×¨×™× ({products.length})</h3>
                            <button onClick={onClose}><Icon name="X" size={24}/></button>
                        </div>
                        <div className="overflow-auto p-4">
                            <table className="w-full text-sm text-right">
                                <thead>
                                    <tr className="text-gray-500 border-b">
                                        <th className="p-2 w-24">×ª×›×•× ×”</th>
                                        {products.map(p => (
                                            <th key={p.id} className="p-2 min-w-[120px]">
                                                <div className="font-bold text-gray-900">{p.title}</div>
                                                <div className="text-xs text-gray-400">{p.sku}</div>
                                            </th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr className="border-b">
                                        <td className="p-3 font-medium bg-gray-50">×ª××•× ×”</td>
                                        {products.map(p => (
                                            <td key={p.id} className="p-2"><img src={p.image} className="w-16 h-16 object-contain mx-auto"/></td>
                                        ))}
                                    </tr>
                                    <tr className="border-b">
                                        <td className="p-3 font-medium bg-gray-50">××—×™×¨</td>
                                        {products.map(p => (
                                            <td key={p.id} className="p-2 font-bold text-saban-600">â‚ª{p.price}</td>
                                        ))}
                                    </tr>
                                    {headers.filter(h => h.key !== 'price').map(h => (
                                        <tr key={h.key} className="border-b last:border-0">
                                            <td className="p-3 font-medium bg-gray-50">{h.label}</td>
                                            {products.map(p => (
                                                <td key={p.id} className="p-2 text-gray-700">{getValue(p, h.path || h.key)}</td>
                                            ))}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const ChatWidget = ({ products }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [msgs, setMsgs] = useState([{role:'bot', text:'××”×œ×Ÿ! ×× ×™ ×”×‘×•×˜ ×©×œ ×¡×‘×Ÿ. ×©××œ ××•×ª×™ ×¢×œ ××•×¦×¨×™×, ×ª×§× ×™× ××• ×”×©×•×•××•×ª.'}]);
            const [input, setInput] = useState('');
            const endRef = useRef(null);

            useEffect(() => endRef.current?.scrollIntoView({ behavior: 'smooth' }), [msgs, isOpen]);

            const analyzeAndRespond = (text) => {
                const lower = text.toLowerCase();
                let response = "×œ× ×”×‘× ×ª×™ ×‘×“×™×•×§. × ×¡×” ×œ×©××•×œ ×¢×œ ×©× ××•×¦×¨ ××• ×§×˜×’×•×¨×™×”.";
                
                const matchedProducts = SmartSearch(text, products);
                
                if (matchedProducts.length === 1) {
                    const p = matchedProducts[0];
                    const insights = ProductAnalyzer.analyze(p);
                    response = `××¦××ª×™ ××ª **${p.title}** (â‚ª${p.price}).\n`;
                    if (p.technicalSpecs?.coveragePerM2) response += `×›×™×¡×•×™: ${p.technicalSpecs.coveragePerM2}.\n`;
                    if (insights.length > 0) response += `ğŸ’¡ ×©×™× ×œ×‘: ${insights[0].text}.`;
                } 
                else if (matchedProducts.length > 1) {
                     response = `××¦××ª×™ ${matchedProducts.length} ××•×¦×¨×™× ××ª××™××™×. ×œ××©×œ: ${matchedProducts[0].title} ×•-${matchedProducts[1].title}. ×ª×¨×¦×” ×œ×”×©×•×•×ª ×‘×™× ×™×”×?`;
                }
                else if (lower.includes('××™×˜×•×')) {
                    response = "×œ××™×˜×•× ×™×© ×œ× ×• ××’×•×•×Ÿ ×¤×ª×¨×•× ×•×ª (×¡×™×§×”, ×ª×¨××•×§×™×¨). ×œ××™×–×” ×¦×•×¨×š? (×’×’, ××¨×¤×¡×ª, ×§×™×¨)";
                }
                return response;
            };

            const send = () => {
                if(!input.trim()) return;
                setMsgs(p => [...p, { role: 'user', text: input }]);
                const txt = input;
                setInput('');
                setTimeout(() => {
                    const ans = analyzeAndRespond(txt);
                    setMsgs(p => [...p, { role: 'bot', text: ans }]);
                }, 600);
            };

            return (
                <>
                    <button onClick={() => setIsOpen(true)} className={`fixed bottom-24 left-4 z-40 p-3 bg-white text-saban-600 rounded-full shadow-xl transition-all ${isOpen ? 'scale-0' : 'scale-100'}`}><Icon name="Bot" size={28} /></button>
                    <AnimatePresence>{isOpen && <motion.div initial={{opacity:0,y:20}} animate={{opacity:1,y:0}} exit={{opacity:0,y:20}} className="fixed bottom-20 left-4 right-4 md:w-80 h-[500px] bg-white shadow-2xl rounded-2xl border z-50 flex flex-col"><div className="bg-saban-600 text-white p-4 flex justify-between shadow-md"><span className="font-bold flex gap-2"><Icon name="Bot" size={18}/> ×”×¢×•×–×¨ ×”×—×›×</span><button onClick={()=>setIsOpen(false)}><Icon name="X" size={18}/></button></div><div className="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">{msgs.map((m,i)=><div key={i} className={`flex ${m.role==='user'?'justify-end':'justify-start'}`}><div className={`p-3 rounded-2xl max-w-[85%] text-sm shadow-sm whitespace-pre-wrap ${m.role==='user'?'bg-saban-600 text-white rounded-tl-none':'bg-white border text-gray-800 rounded-tr-none'}`}>{m.text}</div></div>)}<div ref={endRef}></div></div><div className="p-3 border-t bg-white flex gap-2"><input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&send()} placeholder="×©××œ ××©×”×•..." className="flex-1 bg-gray-100 rounded-full px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-saban-500 transition"/><button onClick={send} className="bg-saban-600 text-white p-2 rounded-full shadow hover:bg-saban-500 transition"><Icon name="Send" size={18}/></button></div></motion.div>}</AnimatePresence>
                </>
            );
        };

        const HomePage = ({ products, categories, addToCompare, compareList, openCompare }) => {
            const [search, setSearch] = useState('');
            const [filter, setFilter] = useState('all');
            
            const filtered = useMemo(() => {
                let res = SmartSearch(search, products);
                if (filter !== 'all') res = res.filter(p => p.category === filter);
                return res;
            }, [search, filter, products]);

            return (
                <div className="pt-4 pb-28 px-4">
                    <div className="flex justify-between items-center mb-6">
                        <div><h1 className="text-2xl font-black text-gray-800">×—.×¡×‘×Ÿ</h1><p className="text-xs text-gray-500">×§×˜×œ×•×’ ×—×›× (PB)</p></div>
                        <img src="https://ui-avatars.com/api/?name=Saban&background=0d9488&color=fff" className="w-10 h-10 rounded-full shadow" />
                    </div>
                    <div className="relative mb-6 z-10">
                        <span className="absolute top-3.5 right-4 text-gray-400"><Icon name="Search" size={18}/></span>
                        <input value={search} onChange={e => setSearch(e.target.value)} className="w-full h-12 pr-12 pl-4 bg-white rounded-2xl shadow-sm outline-none border border-transparent focus:border-saban-500 transition" placeholder="××” ××—×¤×©×™× ×”×™×•×?" />
                    </div>
                    <div className="mb-6 overflow-x-auto hide-scroll">
                        <div className="flex gap-3 w-max px-1 pb-2">
                            {categories.map(cat => (
                                <button key={cat.id} onClick={() => setFilter(cat.id)} className={`flex flex-col items-center justify-center w-20 h-20 rounded-2xl shadow-sm border transition ${filter===cat.id ? 'bg-saban-600 text-white border-transparent' : 'bg-white border-gray-100 text-gray-600'}`}>
                                    <div className="mb-1"><Icon name={cat.icon || 'Box'} size={22} /></div>
                                    <span className="text-xs font-bold">{cat.name}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        {filtered.map(p => {
                            const isSelected = compareList.some(c => c.id === p.id);
                            return (
                                <div key={p.id} className="relative group">
                                    <button onClick={(e) => { e.preventDefault(); addToCompare(p); }} className={`absolute top-2 left-2 z-20 p-1.5 rounded-full shadow-sm transition ${isSelected ? 'bg-saban-600 text-white' : 'bg-white/80 text-gray-400 hover:text-saban-600'}`}><Icon name="Scale" size={16}/></button>
                                    <Link to={`/product/${p.id}`} className="bg-white p-3 rounded-2xl shadow-card flex flex-col h-full border border-transparent hover:border-saban-500 active:scale-95 transition block">
                                        <div className="aspect-square bg-gray-50 rounded-xl mb-3 overflow-hidden relative">
                                            <img src={p.image || 'https://via.placeholder.com/150'} className="w-full h-full object-cover mix-blend-multiply"/>
                                            {p.brand && <span className="absolute bottom-1 right-1 text-[10px] bg-white/90 px-1.5 py-0.5 rounded text-gray-600 font-bold shadow-sm">{p.brand}</span>}
                                        </div>
                                        <h3 className="font-bold text-sm text-gray-800 line-clamp-2 leading-tight">{p.title}</h3>
                                        <div className="mt-auto pt-3 flex justify-between items-end">
                                            <span className="text-lg font-black text-saban-600">â‚ª{p.price}</span>
                                            <div className="w-8 h-8 bg-gray-50 rounded-full flex items-center justify-center text-saban-600 shadow-sm"><Icon name="Plus" size={16} /></div>
                                        </div>
                                    </Link>
                                </div>
                            );
                        })}
                    </div>
                    <AnimatePresence>
                        {compareList.length > 0 && (
                            <motion.div initial={{ y: 100 }} animate={{ y: 0 }} exit={{ y: 100 }} className="fixed bottom-20 left-4 right-4 bg-gray-900 text-white p-4 rounded-2xl shadow-2xl z-30 flex justify-between items-center">
                                <div className="text-sm font-bold">{compareList.length} ××•×¦×¨×™× ×œ×”×©×•×•××”</div>
                                <button onClick={openCompare} className="bg-saban-500 hover:bg-saban-600 px-4 py-2 rounded-xl text-xs font-bold transition">×”×©×•×•×” ×¢×›×©×™×•</button>
                            </motion.div>
                        )}
                    </AnimatePresence>
                </div>
            );
        };

        const ProductPage = ({ products, addToCart }) => {
            const { id } = useParams();
            const nav = useNavigate();
            const p = products.find(x => x.id === id);
            if(!p) return <div className="h-screen flex items-center justify-center">×˜×•×¢×Ÿ...</div>;
            const insights = ProductAnalyzer.analyze(p);
            const alternatives = ProductAnalyzer.findAlternatives(p, products);

            return (
                <div className="bg-gray-50 min-h-screen pb-32">
                    <div className="relative h-80 bg-white">
                        <img src={p.image || 'https://via.placeholder.com/400'} className="w-full h-full object-contain p-6" />
                        <button onClick={() => nav(-1)} className="absolute top-4 right-4 w-10 h-10 bg-white/90 rounded-full flex items-center justify-center shadow-md backdrop-blur z-10"><Icon name="ArrowRight" /></button>
                    </div>
                    <div className="-mt-8 relative z-10 bg-white rounded-t-3xl p-6 shadow-up">
                        <div className="flex justify-between items-start mb-4 border-b pb-4">
                            <div>
                                <div className="flex gap-2 mb-2">
                                    <span className="bg-blue-50 text-blue-700 text-[10px] font-bold px-2 py-1 rounded">{p.brand || '×›×œ×œ×™'}</span>
                                    <span className="bg-gray-100 text-gray-600 text-[10px] font-bold px-2 py-1 rounded">{p.sku}</span>
                                </div>
                                <h1 className="text-2xl font-black text-gray-900 leading-tight">{p.title}</h1>
                            </div>
                            <div className="text-3xl font-black text-saban-600">â‚ª{p.price}</div>
                        </div>
                        {insights.length > 0 && (
                            <div className="mb-6 grid grid-cols-1 gap-2">
                                {insights.map((insight, i) => (
                                    <div key={i} className={`p-3 rounded-xl text-xs font-medium flex items-center gap-3 ${insight.type === 'good' ? 'bg-green-50 text-green-800' : insight.type === 'warn' ? 'bg-yellow-50 text-yellow-800' : 'bg-blue-50 text-blue-800'}`}>
                                        <Icon name={insight.icon} size={18}/> {insight.text}
                                    </div>
                                ))}
                            </div>
                        )}
                        <div className="space-y-6">
                            <section>
                                <h3 className="font-bold mb-2 text-sm text-gray-900 flex gap-2 items-center"><Icon name="FileText" size={16}/> ××¤×¨×˜ ×˜×›× ×™</h3>
                                <div className="grid grid-cols-2 gap-3 text-xs">
                                    <div className="bg-gray-50 p-3 rounded-xl border border-gray-100"><span className="text-gray-400 block mb-1">×›×™×¡×•×™</span><span className="font-bold text-gray-800">{p.technicalSpecs?.coveragePerM2 || '-'}</span></div>
                                    <div className="bg-gray-50 p-3 rounded-xl border border-gray-100"><span className="text-gray-400 block mb-1">×™×™×‘×•×©</span><span className="font-bold text-gray-800">{p.technicalSpecs?.dryingTime || '-'}</span></div>
                                    <div className="bg-gray-50 p-3 rounded-xl border border-gray-100"><span className="text-gray-400 block mb-1">×ª×§×Ÿ</span><span className="font-bold text-gray-800">{p.technicalSpecs?.standard || '-'}</span></div>
                                </div>
                            </section>
                            <section>
                                <h3 className="font-bold mb-2 text-sm text-gray-900">×ª×™××•×¨</h3>
                                <p className="text-sm text-gray-500 leading-relaxed">{p.description}</p>
                            </section>
                        </div>
                    </div>
                    <div className="fixed bottom-0 w-full p-4 bg-white border-t z-20 pb-safe shadow-up">
                        <button onClick={() => addToCart(p)} className="w-full bg-saban-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-saban-200 flex items-center justify-center gap-2 active:scale-95 transition">
                            <Icon name="ShoppingBag" size={20}/> ×”×•×¡×£ ×œ×”×–×× ×”
                        </button>
                    </div>
                </div>
            );
        };

        const CartPage = ({ cart, updateQty, clearCart }) => {
            const [form, setForm] = useState({ name: '', phone: '' });
            const total = cart.reduce((acc, i) => acc + (i.product.price * i.qty), 0);
            const send = () => {
                if(!form.name || !form.phone) return alert("×—×•×‘×” ×œ××œ× ×©× ×•×˜×œ×¤×•×Ÿ");
                let msg = `×”×–×× ×” ×—×“×©×”:\n`;
                cart.forEach((item, i) => msg += `${i+1}. ${item.product.title} (x${item.qty})\n`);
                msg += `×¡×”"×›: â‚ª${total}\n×œ×§×•×—: ${form.name} ${form.phone}`;
                const PHONE_NUMBER = "972508860896";
                window.open(`https://wa.me/${PHONE_NUMBER}?text=${encodeURIComponent(msg)}`, '_blank');
                if(confirm("×œ× ×§×•×ª ×¡×œ?")) clearCart();
            };
            if(!cart.length) return <div className="h-screen flex flex-col items-center justify-center text-gray-400 gap-4"><Icon name="ShoppingCart" size={48} opacity={0.2} /><p>×”×¢×’×œ×” ×¨×™×§×”</p></div>;
            return (
                <div className="pt-6 pb-24 px-4 bg-gray-50 min-h-screen">
                    <h1 className="text-2xl font-black mb-6">×”×–×× ×”</h1>
                    <div className="space-y-3 mb-8">{cart.map(item => (<div key={item.product.id} className="bg-white p-3 rounded-xl shadow-sm flex gap-3"><div className="flex-1"><h4 className="font-bold text-sm text-gray-800">{item.product.title}</h4><div className="text-saban-600 font-bold">â‚ª{item.product.price * item.qty}</div></div><div className="flex items-center gap-3"><button onClick={() => updateQty(item.product.id, -1)} className="w-8 h-8 flex items-center justify-center bg-gray-100 rounded-lg">-</button><span className="font-bold">{item.qty}</span><button onClick={() => updateQty(item.product.id, 1)} className="w-8 h-8 flex items-center justify-center bg-gray-100 rounded-lg">+</button></div></div>))}</div>
                    <div className="bg-white p-5 rounded-2xl shadow-sm space-y-3 mb-6"><h3 className="font-bold text-sm">×¤×¨×˜×™ ×œ×§×•×—</h3><input value={form.name} onChange={e=>setForm({...form, name:e.target.value})} placeholder="×©× ××œ× *" className="w-full bg-gray-50 p-3 rounded-xl"/><input value={form.phone} onChange={e=>setForm({...form, phone:e.target.value})} type="tel" placeholder="×˜×œ×¤×•×Ÿ *" className="w-full bg-gray-50 p-3 rounded-xl"/></div>
                    <div className="fixed bottom-0 left-0 w-full bg-white p-4 border-t z-20 pb-safe"><div className="flex justify-between mb-3 font-bold text-lg"><span>×¡×”"×›:</span><span>â‚ª{total}</span></div><button onClick={send} className="w-full bg-green-600 text-white py-3.5 rounded-xl font-bold shadow-lg flex justify-center gap-2">×©×œ×— ×œ×•×•×˜×¡××¤ <Icon name="Send" size={18}/></button></div>
                </div>
            );
        };
        const ScannerPage = () => <div className="h-screen flex items-center justify-center bg-black text-white">×¡×•×¨×§...</div>;

        const App = () => {
            const [products, setProducts] = useState([]);
            const [categories, setCategories] = useState([]);
            const [cart, setCart] = useState(() => JSON.parse(localStorage.getItem('saban_cart')||'[]'));
            const [compareList, setCompareList] = useState([]);
            const [showCompare, setShowCompare] = useState(false);
            const [installPrompt, setInstallPrompt] = useState(null);

            useEffect(() => {
                // Initialize PocketBase subscriptions
                const unsubProd = DataService.subscribeProducts(setProducts);
                DataService.subscribeCategories(setCategories);
                
                window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); setInstallPrompt(e); });
                return () => { if(unsubProd) unsubProd(); };
            }, []);

            useEffect(() => localStorage.setItem('saban_cart', JSON.stringify(cart)), [cart]);

            const addToCart = (p) => {
                setCart(prev => {
                    const exist = prev.find(i => i.product.id === p.id);
                    if(exist) return prev.map(i => i.product.id === p.id ? {...i, qty: i.qty+1} : i);
                    return [...prev, { product: p, qty: 1 }];
                });
                alert("×”××•×¦×¨ × ×•×¡×£ ×œ×¢×’×œ×”!");
            };

            const addToCompare = (p) => {
                if (compareList.find(c => c.id === p.id)) {
                    setCompareList(prev => prev.filter(c => c.id !== p.id));
                } else {
                    if (compareList.length >= 3) alert("× ×™×ª×Ÿ ×œ×”×©×•×•×ª ×¢×“ 3 ××•×¦×¨×™×");
                    else setCompareList(prev => [...prev, p]);
                }
            };

            const updateQty = (pid, delta) => {
                setCart(prev => {
                    if(delta === 0) return prev.filter(i => i.product.id !== pid);
                    return prev.map(i => i.product.id === pid ? { ...i, qty: Math.max(0, i.qty + delta) } : i).filter(i => i.qty > 0);
                });
            };

            const installApp = () => {
                if(installPrompt) installPrompt.prompt();
            };

            return (
                <HashRouter>
                    <div className="max-w-md mx-auto bg-white min-h-screen shadow-2xl relative overflow-hidden">
                        {installPrompt && <div className="bg-saban-600 text-white text-center p-2 text-sm font-bold cursor-pointer" onClick={installApp}>ğŸ“² ×œ×—×¥ ×œ×”×ª×§× ×ª ×”××¤×œ×™×§×¦×™×”</div>}
                        
                        <Routes>
                            <Route path="/" element={<HomePage products={products} categories={categories} addToCompare={addToCompare} compareList={compareList} openCompare={()=>setShowCompare(true)} />} />
                            <Route path="/product/:id" element={<ProductPage products={products} addToCart={addToCart} />} />
                            <Route path="/cart" element={<CartPage cart={cart} updateQty={updateQty} clearCart={()=>setCart([])} />} />
                            <Route path="/scan" element={<ScannerPage />} />
                        </Routes>
                        
                        <ChatWidget products={products} />
                        <NavBar cartCount={cart.reduce((a,b)=>a+b.qty,0)} />

                        {showCompare && <ComparisonTable products={compareList} onClose={()=>setShowCompare(false)} />}
                    </div>
                </HashRouter>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
