<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ח.סבן - קטלוג וצבעים</title>
    
    <!-- PWA Manifest (Embedded for stability) -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuYXneXlueZl9ecIOXlueZl9ecIC0g16DXmdlVF15wiLAogICJzaG9ydF9uYW1lIjogIuYXneXlueZl9ecIiwKICAic3RhcnRfdXJsIjogIi4vaW5kZXguaHRtbCIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmZmZmZmYiLAogICJ0aGVtZV9jb2xvciI6ICIjMTRiOGE2IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9jZG4taWNvbnMtcG5nLmZsYXRpY29uLmNvbS81MTIvMjUvMjU2OTQucG5nIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXQp9">
    <meta name="theme-color" content="#0d9488">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/25/25694.png">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- React Stack -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/history@5/umd/history.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-router@6.3.0/umd/react-router.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-router-dom@6.3.0/umd/react-router-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>

    <!-- Design System -->
    <style>
        body { background-color: #f8fafc; font-family: system-ui, -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-top: 1px solid rgba(0,0,0,0.05); }
        .hide-scroll::-webkit-scrollbar { display: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Chat Styles */
        .chat-bubble { max-width: 85%; padding: 12px; border-radius: 16px; margin-bottom: 8px; font-size: 14px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .chat-bot { background: #ffffff; border: 1px solid #e2e8f0; color: #1e293b; border-bottom-right-radius: 4px; }
        .chat-user { background: #0d9488; color: white; border-bottom-left-radius: 4px; margin-right: auto; }
        
        /* Color Card */
        .color-swatch { height: 80px; width: 100%; transition: transform 0.2s; }
        .color-card:active { transform: scale(0.98); }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase Logic Module -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, query, where, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA3qwgBX69Clu7pUdOnOEcfzUVyR7ADrNc",
            authDomain: "saban94-eb5f0.firebaseapp.com",
            projectId: "saban94-eb5f0",
            storageBucket: "saban94-eb5f0.firebasestorage.app",
            messagingSenderId: "656829273946",
            appId: "1:656829273946:web:8ebcb440ed280aff014563",
            measurementId: "G-PQGYJ2YQRK"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Auto Anonymous Auth
        onAuthStateChanged(auth, (user) => {
            if (!user) signInAnonymously(auth).catch(console.error);
        });

        // Public API for React
        window.dbService = {
            // Products Realtime
            subscribeProducts: (cb) => onSnapshot(collection(db, "products"), s => cb(s.docs.map(d=>({id:d.id, ...d.data()})))),
            
            // Categories Realtime
            subscribeCategories: (cb) => onSnapshot(collection(db, "categories"), s => cb(s.docs.map(d=>({id:d.id, ...d.data()})))),

            // Color Search (Client-side filter on limited fetch for speed)
            searchColors: async (term) => {
                if(!term || term.length < 2) return [];
                const qLower = term.toLowerCase().replace(/\s+/g, ''); 
                // Fetch first 100 to filter locally (Firestore limitation on partial string search)
                const qRef = query(collection(db, "colors"), limit(100)); 
                const snap = await getDocs(qRef);
                
                return snap.docs.map(d => d.data()).filter(c => {
                    const code = (c.code || '').toLowerCase().replace(/_/g, '');
                    const name = (c.name || '').toLowerCase();
                    return code.includes(qLower) || name.includes(qLower);
                });
            },
            
            // Fetch Colors by Brand
            getColorsByBrand: async (brand) => {
                const q = query(collection(db, "colors"), where("brandId", "==", brand), limit(100));
                const snap = await getDocs(q);
                return snap.docs.map(d => d.data());
            },

            // Create Order
            createOrder: async (order) => {
                const ref = await addDoc(collection(db, "orders"), {
                    ...order,
                    status: 'pending',
                    createdAt: serverTimestamp(),
                    userId: auth.currentUser ? auth.currentUser.uid : 'guest'
                });
                return ref.id;
            }
        };

        // Branches Data
        window.BRANCHES = [
            { id: 'talmid', name: 'התלמיד 6, הוד השרון', waze: 'https://waze.com/ul?ll=32.158,34.890&navigate=yes' },
            { id: 'harash', name: 'החרש 10, הוד השרון', waze: 'https://waze.com/ul?ll=32.155,34.885&navigate=yes' }
        ];
    </script>

    <!-- React App Logic -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { HashRouter, Routes, Route, Link, useNavigate, useParams, useLocation } = ReactRouterDOM;
        const { motion, AnimatePresence } = window.Motion;

        // --- 1. UI COMPONENTS ---

        // Safe Icon (Lucide Wrapper)
        const Icon = ({ name, size = 20, className }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && window.lucide && window.lucide.icons[name]) {
                    const svg = window.lucide.createElement(window.lucide.icons[name]);
                    svg.setAttribute('width', size); svg.setAttribute('height', size);
                    if (className) svg.setAttribute('class', className);
                    ref.current.innerHTML = ''; ref.current.appendChild(svg);
                }
            }, [name, size, className]);
            return <span ref={ref} className="inline-flex items-center justify-center"/>;
        };

        // Order Modal
        const OrderModal = ({ item, onClose, onSubmit }) => {
            const [qty, setQty] = useState(1);
            const [size, setSize] = useState('5L');
            const [branchId, setBranchId] = useState(window.BRANCHES[0].id);
            const [name, setName] = useState('');
            const [phone, setPhone] = useState('');

            const handleSubmit = () => {
                if(!name || !phone) return alert("נא למלא שם וטלפון");
                const branch = window.BRANCHES.find(b => b.id === branchId);
                
                onSubmit({
                    customer: { name, phone },
                    item: { ...item, qty, size },
                    branch,
                    pickupTime: new Date().toLocaleTimeString() // Default to now
                });
            };

            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center p-4 animate-in fade-in">
                    <div className="bg-white w-full max-w-md rounded-2xl overflow-hidden shadow-2xl pb-safe">
                        <div className="bg-teal-700 p-4 text-white flex justify-between items-center">
                            <h3 className="font-bold">הזמנת גוון</h3>
                            <button onClick={onClose}><Icon name="X"/></button>
                        </div>
                        <div className="p-4 space-y-4">
                            <div className="flex gap-3 items-center bg-gray-50 p-2 rounded-lg border">
                                <div className="w-12 h-12 rounded border shadow-sm" style={{backgroundColor: item.hex || '#eee'}}></div>
                                <div>
                                    <div className="font-bold text-sm">{item.code}</div>
                                    <div className="text-xs text-gray-500">{item.name} ({item.brandId})</div>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-3">
                                <div className="flex items-center border rounded-lg p-1">
                                    <button onClick={()=>setQty(Math.max(1,qty-1))} className="p-2 text-gray-500"><Icon name="Minus" size={16}/></button>
                                    <span className="flex-1 text-center font-bold">{qty}</span>
                                    <button onClick={()=>setQty(qty+1)} className="p-2 text-gray-500"><Icon name="Plus" size={16}/></button>
                                </div>
                                <select value={size} onChange={e=>setSize(e.target.value)} className="w-full p-2 border rounded-lg bg-white text-sm">
                                    <option value="1L">1 ליטר</option>
                                    <option value="5L">5 ליטר</option>
                                    <option value="18L">18 ליטר</option>
                                </select>
                            </div>

                            <select value={branchId} onChange={e=>setBranchId(e.target.value)} className="w-full p-3 border rounded-lg bg-white text-sm">
                                {window.BRANCHES.map(b => <option key={b.id} value={b.id}>{b.name}</option>)}
                            </select>

                            <div className="grid grid-cols-2 gap-2">
                                <input placeholder="שם מלא" value={name} onChange={e=>setName(e.target.value)} className="p-3 border rounded-lg text-sm"/>
                                <input placeholder="טלפון" value={phone} onChange={e=>setPhone(e.target.value)} type="tel" className="p-3 border rounded-lg text-sm"/>
                            </div>

                            <button onClick={handleSubmit} className="w-full bg-teal-600 text-white py-3.5 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 active:scale-95 transition">
                                <Icon name="CheckCircle"/> אשר והזמן ב-WhatsApp
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 2. FEATURE PAGES ---

        // Color Fans Page
        const ColorFanPage = ({ addToCart }) => {
            const [brand, setBrand] = useState('nirlat');
            const [colors, setColors] = useState([]);
            const [loading, setLoading] = useState(false);
            const [selected, setSelected] = useState(null);
            const [search, setSearch] = useState('');
            const [showModal, setShowModal] = useState(false);

            // Load colors
            useEffect(() => {
                setLoading(true);
                if(window.dbService) {
                    window.dbService.getColorsByBrand(brand).then(res => {
                        setColors(res);
                        setLoading(false);
                    });
                }
            }, [brand]);

            // Handle search
            const handleSearch = async (e) => {
                const val = e.target.value;
                setSearch(val);
                if(val.length > 2) {
                    setLoading(true);
                    const res = await window.dbService.searchColors(val);
                    setColors(res);
                    setLoading(false);
                } else if (val.length === 0) {
                    window.dbService.getColorsByBrand(brand).then(setColors);
                }
            };

            const handleOrderSubmit = async (orderData) => {
                setShowModal(false);
                try {
                    const orderId = await window.dbService.createOrder(orderData);
                    const { item, customer, branch } = orderData;
                    
                    // WhatsApp Format
                    const text = `הזמנה חדשה #${orderId}
לקוח: ${customer.name} (${customer.phone})
גוון: ${item.brand} ${item.code} ${item.name}
כמות: ${item.qty} יח' (${item.size})
סניף: ${branch.name}
ניווט: ${branch.waze}`;

                    window.open(`https://wa.me/972508860896?text=${encodeURIComponent(text)}`, '_blank');
                    alert("ההזמנה נשלחה לווטסאפ!");
                    setSelected(null);
                } catch (e) { alert("שגיאה בשליחה"); }
            };

            return (
                <div className="pb-24 pt-4 px-4">
                    <h2 className="text-2xl font-black text-gray-800 mb-4 flex items-center gap-2"><Icon name="Palette"/> מניפות צבע</h2>
                    
                    <div className="flex bg-gray-200 p-1 rounded-xl mb-4">
                        <button onClick={()=>setBrand('nirlat')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${brand==='nirlat' ? 'bg-white text-teal-600 shadow' : 'text-gray-500'}`}>נירלט</button>
                        <button onClick={()=>setBrand('tambour')} className={`flex-1 py-2 rounded-lg text-sm font-bold transition ${brand==='tambour' ? 'bg-white text-red-600 shadow' : 'text-gray-500'}`}>טמבור</button>
                    </div>

                    <div className="relative mb-4">
                        <span className="absolute top-3 right-3 text-gray-400"><Icon name="Search" size={18}/></span>
                        <input 
                            value={search} onChange={handleSearch}
                            className="w-full p-3 pr-10 rounded-xl border-none shadow-sm focus:ring-2 focus:ring-teal-500 outline-none" 
                            placeholder={`חפש גוון ${brand==='nirlat'?'נירלט':'טמבור'}...`} 
                        />
                    </div>

                    {loading ? <div className="text-center py-10 text-gray-400">טוען גוונים...</div> : (
                        <div className="grid grid-cols-3 gap-3">
                            {colors.map((c, i) => (
                                <motion.div 
                                    key={i} 
                                    whileTap={{ scale: 0.95 }}
                                    onClick={()=>{ setSelected(c); setShowModal(true); }} 
                                    className="bg-white rounded-lg overflow-hidden shadow-sm border cursor-pointer"
                                >
                                    <div style={{height:'70px', background: c.hex || '#eee'}} className="relative">
                                        {c.imageUrl && <img src={c.imageUrl} className="w-full h-full object-cover opacity-80"/>}
                                    </div>
                                    <div className="p-2 text-center">
                                        <div className="font-bold text-xs truncate text-gray-800">{c.code}</div>
                                        <div className="text-[10px] text-gray-500 truncate">{c.name}</div>
                                    </div>
                                </motion.div>
                            ))}
                        </div>
                    )}
                    {colors.length === 0 && !loading && <div className="text-center p-10 text-gray-400">לא נמצאו גוונים.</div>}

                    {/* Order Modal */}
                    {showModal && selected && (
                        <OrderModal 
                            item={{...selected, brandId: brand}} 
                            onClose={()=>setShowModal(false)} 
                            onSubmit={handleOrderSubmit} 
                        />
                    )}
                </div>
            );
        };

        // ChatBot v2.0 (Connected to Fans)
        const ChatWidget = ({ products }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [msgs, setMsgs] = useState([{role:'bot', text:'היי! אני הבוט של סבן. חפש מוצר או גוון (למשל IS 0072).'}]);
            const [input, setInput] = useState('');
            const [colorOrder, setColorOrder] = useState(null);
            const endRef = useRef(null);

            useEffect(() => endRef.current?.scrollIntoView({ behavior: 'smooth' }), [msgs, isOpen]);

            const handleOrderSubmit = async (orderData) => {
                setColorOrder(null);
                setMsgs(prev => [...prev, {role:'bot', text:'מכין הזמנה... ⏳'}]);
                try {
                    const orderId = await window.dbService.createOrder(orderData);
                    const { item, customer, branch } = orderData;
                    const text = `הזמנה #${orderId}\nלקוח: ${customer.name}\nגוון: ${item.brand} ${item.code}\nכמות: ${item.qty} (${item.size})\nסניף: ${branch.name}\nניווט: ${branch.waze}`;
                    const link = `https://wa.me/972508860896?text=${encodeURIComponent(text)}`;
                    setMsgs(prev => [...prev, { 
                        role:'bot', 
                        text: `הזמנה נקלטה בהצלחה! (#${orderId}). לחץ לשליחה:`,
                        link: link
                    }]);
                } catch (e) { setMsgs(prev => [...prev, {role:'bot', text:'שגיאה.'}]); }
            };

            const send = () => {
                if(!input.trim()) return;
                const txt = input;
                setMsgs(p => [...p, { role: 'user', text: txt }]);
                setInput('');

                setTimeout(async () => {
                    let ans = "לא מצאתי. נסה קוד גוון מדויק.";
                    const lower = txt.toLowerCase();

                    // זיהוי גוון
                    if (/^[a-z]{2}[_\s]?\d{3,4}$/i.test(txt) || txt.includes('גוון')) {
                         const colors = await window.dbService.searchColor(txt);
                         if(colors.length > 0) {
                             const c = colors[0];
                             ans = `מצאתי גוון: **${c.code}** (${c.name}).`;
                             setMsgs(prev => [...prev, { role: 'bot', text: ans, colorCard: c }]);
                             return;
                         }
                    } 
                    // זיהוי מוצר
                    else {
                        const p = products.find(pr => pr.title.includes(txt));
                        if(p) ans = `יש לנו ${p.title} במחיר ₪${p.price}.`;
                    }
                    
                    setMsgs(p => [...p, { role: 'bot', text: ans }]);
                }, 600);
            };

            return (
                <>
                    <button onClick={() => setIsOpen(true)} className={`fixed bottom-24 left-4 z-40 p-3 bg-teal-600 text-white rounded-full shadow-xl transition-all ${isOpen ? 'scale-0' : 'scale-100'}`}><Icon name="Bot" size={28} /></button>
                    {isOpen && (
                        <div className="fixed bottom-20 left-4 right-4 md:w-80 h-[450px] bg-white shadow-2xl rounded-2xl border z-50 flex flex-col overflow-hidden">
                            <div className="bg-teal-600 text-white p-3 flex justify-between shadow-md"><span className="font-bold flex gap-2"><Icon name="Bot"/> SabanAI</span><button onClick={()=>setIsOpen(false)}><Icon name="X"/></button></div>
                            <div className="flex-1 overflow-y-auto p-3 space-y-3 bg-gray-50">
                                {msgs.map((m,i)=>(
                                    <div key={i} className={`flex flex-col ${m.role==='user'?'items-end':'items-start'}`}>
                                        <div className={`p-2 rounded-xl max-w-[85%] text-sm ${m.role==='user'?'bg-teal-600 text-white':'bg-white border text-gray-800'}`}>{m.text}</div>
                                        {m.colorCard && (
                                            <div className="bg-white border p-2 rounded-xl shadow-sm w-48 mt-1 mb-3">
                                                <div className="h-16 w-full rounded mb-2" style={{background: m.colorCard.hex || '#ddd'}}></div>
                                                <div className="font-bold text-sm">{m.colorCard.code}</div>
                                                <div className="text-xs text-gray-500">{m.colorCard.name}</div>
                                                <button onClick={() => setColorOrder(m.colorCard)} className="w-full mt-2 bg-green-600 text-white text-xs py-2 rounded font-bold">הזמן עכשיו</button>
                                            </div>
                                        )}
                                        {m.link && <a href={m.link} target="_blank" className="mt-1 bg-green-500 text-white px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1 shadow"><Icon name="MessageCircle" size={12}/> שלח לווטסאפ</a>}
                                    </div>
                                ))}
                                <div ref={endRef}></div>
                            </div>
                            <div className="p-2 border-t flex gap-2"><input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&send()} placeholder="שאל..." className="flex-1 bg-gray-100 rounded-full px-3 outline-none"/><button onClick={send} className="text-teal-600"><Icon name="Send"/></button></div>
                        </div>
                    )}
                    {colorOrder && <OrderModal item={{...colorOrder, brandId: 'מניפה'}} onClose={()=>setColorOrder(null)} onSubmit={handleOrderSubmit} />}
                </>
            );
        };

        // --- Main App ---
        const NavBar = ({ cartCount }) => {
            const loc = useLocation();
            const isActive = (p) => loc.pathname === p ? 'text-teal-600' : 'text-gray-400';
            return (
                <div className="fixed bottom-0 w-full bg-white glass pb-safe border-t z-30 h-16 flex justify-around items-center px-2">
                    <Link to="/" className={`flex flex-col items-center gap-1 text-[10px] font-medium ${isActive('/')}`}><Icon name="Home" size={22} /><span>ראשי</span></Link>
                    <Link to="/colors" className={`flex flex-col items-center gap-1 text-[10px] font-medium ${isActive('/colors')}`}><Icon name="Palette" size={22} /><span>מניפות</span></Link>
                    <Link to="/cart" className={`flex flex-col items-center gap-1 text-[10px] font-medium relative ${isActive('/cart')}`}><Icon name="ShoppingCart" size={22} />{cartCount > 0 && <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center">{cartCount}</span>}<span>עגלה</span></Link>
                </div>
            );
        };

        const App = () => {
            const [products, setProducts] = useState([]);
            const [cart, setCart] = useState([]);

            useEffect(() => {
                if(window.dbService) window.dbService.subscribeProducts(setProducts);
            }, []);

            return (
                <HashRouter>
                    <div className="max-w-md mx-auto bg-white min-h-screen shadow-2xl relative pb-20">
                        <Routes>
                            <Route path="/" element={<div className="p-8 text-center"><h1 className="text-2xl font-bold text-teal-800 mb-2">ח.סבן</h1><p className="text-gray-500">בחר מניפות בתפריט</p></div>} />
                            <Route path="/colors" element={<ColorFanPage addToCart={(item)=>setCart(p=>[...p, item])} />} />
                            <Route path="/cart" element={<div className="p-4">עגלה ({cart.length})</div>} />
                        </Routes>
                        <ChatWidget products={products} />
                        <NavBar cartCount={cart.length} />
                    </div>
                </HashRouter>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        setTimeout(() => lucide.createIcons(), 1000);
    </script>
</body>
</html>
