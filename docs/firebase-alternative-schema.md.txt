const functions = require("firebase-functions");
const admin = require("firebase-admin");
const axios = require("axios");

admin.initializeApp();
const db = admin.firestore();

// --- Configuration ---
// 祝 注专 转 砖 住驻拽 住驻 专 (砖 Green-API)
const WHATSAPP_API_URL = "https://api.green-api.com/waInstance1101/SendMessage/YOUR_TOKEN";
const INSTANCE_ID = "YOUR_INSTANCE";
const API_TOKEN = "YOUR_TOKEN";

/**
 * Webhook 拽转 注转 住转 住驻
 * 转转  转 爪 住驻拽 住驻 (Callback URL)
 */
exports.whatsappWebhook = functions.https.onRequest(async (req, res) => {
  try {
    const body = req.body;
    
    // 专 注 驻  砖 Green-API ()
    // 砖 :  砖转  住驻拽 (Twilio/WATI ')
    if (body.typeWebhook === 'incomingMessageReceived') {
      const messageData = body.messageData;
      const senderData = body.senderData;
      
      const phone = senderData.sender.replace('@c.us', ''); // 97250...
      const text = messageData.textMessageData.textMessage;
      const name = senderData.senderName;

      // 1. 砖专转 注 -Firestore
      const chatRef = db.collection('chats').doc(phone);
      const msgRef = chatRef.collection('messages').doc();

      await db.runTransaction(async (t) => {
        t.set(chatRef, {
            chatId: phone,
            lastMessageText: text,
            lastMessageTime: admin.firestore.FieldValue.serverTimestamp(),
            customerName: name,
            unreadCount: admin.firestore.FieldValue.increment(1)
        }, { merge: true });

        t.set(msgRef, {
            direction: 'inbound',
            content: text,
            timestamp: admin.firestore.FieldValue.serverTimestamp(),
            status: 'delivered'
        });
      });

      // 2. 驻注转 拽转  住住转
      await handleBotLogic(phone, text, name);
    }

    res.status(200).send('OK');
  } catch (error) {
    console.error("Error processing webhook:", error);
    res.status(500).send('Error');
  }
});

/**
 * 拽转 爪'  驻砖
 */
async function handleBotLogic(phone, text, name) {
    const lowerText = text.toLowerCase().trim();
    let replyText = "";

    if (["砖", "", "转"].some(w => lowerText.includes(w))) {
        replyText = ` ${name || '拽 拽专'}! 专  .住 专  锔\n 驻砖专 注专?\n1. 爪注  砖\n2. 拽 住住 \n3. 爪 砖专转`;
    } else if (lowerText === "1" || lowerText.includes("")) {
        replyText = "注. 转   转 专砖转 专 砖转 爪专,  砖 转, 住专 专  注 爪注转 专.";
    } else if (lowerText === "2" || lowerText.includes("住住")) {
        // 砖驻 -DB 砖  专
        const lastOrderSnap = await db.collection('orders')
            .where('customerId', '==', phone)
            .orderBy('createdAt', 'desc')
            .limit(1)
            .get();
        
        if (!lastOrderSnap.empty) {
            const order = lastOrderSnap.docs[0].data();
            replyText = ` 专 砖 (${order.orderId}) 爪转 住住: *${translateStatus(order.status)}*`;
        } else {
            replyText = " 爪转 转 驻注转 注专转.";
        }
    } else {
         // 专专转  -     驻专,  注专 爪
         return; 
    }

    if (replyText) {
        await sendWhatsApp(phone, replyText);
    }
}

/**
 * 驻拽爪转 注专 砖转 注
 */
async function sendWhatsApp(to, message) {
    try {
        await axios.post(WHATSAPP_API_URL, {
            chatId: `${to}@c.us`,
            message: message
        });
        
        // 转注 注 爪转 -DB
        await db.collection('chats').doc(to).collection('messages').add({
            direction: 'outbound',
            content: message,
            timestamp: admin.firestore.FieldValue.serverTimestamp(),
            status: 'sent'
        });

    } catch (e) {
        console.error("Failed to send WhatsApp", e);
    }
}

function translateStatus(status) {
    const map = { 'new': '拽', 'shipping': '专 ', 'delivered': '住专' };
    return map[status] || status;
}

/**
 * 专专: 注 拽 砖专 住住  砖转
 */
exports.onOrderStatusChange = functions.firestore
    .document('orders/{orderId}')
    .onUpdate(async (change, context) => {
        const newData = change.after.data();
        const oldData = change.before.data();

        if (newData.status !== oldData.status) {
            const msg = `注  ${newData.orderId}: 住住 砖 -${translateStatus(newData.status)}`;
            await sendWhatsApp(newData.customerId, msg);
        }
    });