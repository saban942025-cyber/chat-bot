<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saban Admin - PocketBase</title>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/25/25694.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/pocketbase/dist/pocketbase.umd.js"></script>
    <style>
        body { background-color: #111827; color: white; font-family: sans-serif; }
        .input-dark { background: #1f2937; border: 1px solid #374151; color: white; padding: 8px; border-radius: 6px; width: 100%; margin-bottom: 10px; }
        .btn { padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-primary { background: #14b8a6; color: white; }
        .btn-primary:hover { background: #0d9488; }
        .glass-panel { background: rgba(31, 41, 55, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(75, 85, 99, 0.4); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        // --- PocketBase Connection ---
        // ⚠️ חשוב: החלף את הכתובת הזו בכתובת האמיתית של ה-Cloudflare Tunnel שלך!
        // כרגע זה מכוון לכתובת דוגמה שגורמת לשגיאה.
        const PB_URL = 'https://YOUR-REAL-TUNNEL-ADDRESS.trycloudflare.com';
        
        const pb = new PocketBase(PB_URL);
        pb.autoCancellation(false);

        // --- Data Service (PB Adapter) ---
        const dbService = {
            getProducts: async (cb) => {
                const records = await pb.collection('products').getFullList({ sort: '-created' }).catch(err => {
                    console.error("Fetch Error:", err);
                    if(err.status === 0) alert("שגיאת חיבור. בדוק את ה-Tunnel.");
                });
                if(records) cb(records);
            },
            saveProduct: async (data, id) => {
                try {
                    if(id) await pb.collection('products').update(id, data);
                    else await pb.collection('products').create(data);
                } catch(e) { console.error(e); alert("שגיאה בשמירה: " + e.message); }
            },
            deleteProduct: async (id) => {
                if(confirm("למחוק?")) {
                    await pb.collection('products').delete(id);
                    return true;
                }
                return false;
            },
            getCategories: async (cb) => {
                try {
                    const list = await pb.collection('categories').getFullList();
                    cb(list);
                } catch(e) { cb([]); }
            },
            addCategory: async (cat) => {
                // בדיקה אם קיים
                // ב-PB לכל רשומה יש ID אוטומטי, אבל אנחנו רוצים להשתמש ב-ID שלנו לסינון
                // לכן נחפש אם קיים שדה מזהה אחר או פשוט ניצור חדש
                await pb.collection('categories').create(cat);
            },
            deleteCategory: async (id) => {
                if(confirm("למחוק קטגוריה?")) await pb.collection('categories').delete(id);
            }
        };

        // --- Components ---
        const Icon = ({ name, size = 20 }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (ref.current && window.lucide && window.lucide.icons[name]) {
                    const svg = window.lucide.createElement(window.lucide.icons[name]);
                    svg.setAttribute('width', size); svg.setAttribute('height', size);
                    ref.current.innerHTML = ''; ref.current.appendChild(svg);
                }
            }, [name]);
            return <span ref={ref} className="inline-flex items-center justify-center" />;
        };

        const ProductSearch = ({ onSelect }) => {
            const [query, setQuery] = useState('');
            const [results, setResults] = useState([]);
            const [loading, setLoading] = useState(false);

            const searchGoogle = async () => {
                if (!query) return;
                setLoading(true);
                try {
                    // מפתחות ה-API שסיפקת נשמרו כאן
                    const GOOGLE_API_KEY = "AIzaSyBtTsufWhuB7_Xn6TUONpGQ7ydlpmgynUI"; 
                    const CX = "3331a7d5c75e14f26"; 
                    const url = `https://www.googleapis.com/customsearch/v1?key=${GOOGLE_API_KEY}&cx=${CX}&q=${encodeURIComponent(query)}`;
                    const res = await fetch(url);
                    const data = await res.json();
                    setResults(data.items || []);
                } catch (e) { alert("שגיאה בחיפוש"); } 
                finally { setLoading(false); }
            };

            return (
                <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 mb-8 shadow-2xl">
                    <h2 className="text-xl font-bold text-teal-400 mb-4 flex gap-2"><Icon name="Search"/> איתור מוצר ברשת</h2>
                    <div className="flex gap-2 mb-4">
                        <input value={query} onChange={(e) => setQuery(e.target.value)} onKeyDown={(e)=>e.key==='Enter'&&searchGoogle()} placeholder="שם מוצר..." className="input-dark mb-0 flex-1"/>
                        <button onClick={searchGoogle} className="btn btn-primary w-32">{loading ? '...' : 'חפש'}</button>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 max-h-60 overflow-y-auto">
                        {results.map((item, idx) => {
                            const img = item.pagemap?.cse_image?.[0]?.src || item.pagemap?.og_image?.[0]?.src || '';
                            return (
                                <div key={idx} className="bg-gray-700 p-3 rounded-lg border border-gray-600 flex flex-col gap-2">
                                    <div className="flex gap-3">
                                        {img && <img src={img} className="w-12 h-12 object-cover rounded bg-white" />}
                                        <div className="flex-1 overflow-hidden">
                                            <h4 className="font-bold text-sm text-blue-300 truncate">{item.title}</h4>
                                            <p className="text-xs text-gray-400 truncate">{item.snippet}</p>
                                        </div>
                                    </div>
                                    <button onClick={() => onSelect({ title: item.title, description: item.snippet, image: img })} className="btn btn-primary text-xs w-full mt-auto py-1">⬇️ העתק לטופס</button>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const AdminApp = () => {
            const [products, setProducts] = useState([]);
            const [categories, setCategories] = useState([]);
            const [editMode, setEditMode] = useState(false);
            const [currentId, setCurrentId] = useState(null);
            
            const [form, setForm] = useState({
                title: '', sku: '', price: '', category: 'all', description: '', image: '',
                features: '', coverage: '', drying: '', standard: ''
            });

            const refresh = () => {
                dbService.getProducts(setProducts);
                dbService.getCategories(setCategories);
            };

            useEffect(() => { refresh(); }, []);

            const handleSubmit = async (e) => {
                e.preventDefault();
                const data = {
                    title: form.title,
                    sku: form.sku,
                    price: Number(form.price),
                    description: form.description,
                    image: form.image,
                    category: form.category,
                    features: form.features.split(',').map(s=>s.trim()).filter(Boolean), // Array
                    technicalSpecs: { // JSON Object
                        coveragePerM2: form.coverage,
                        dryingTime: form.drying,
                        standard: form.standard
                    }
                };
                await dbService.saveProduct(data, currentId);
                alert(editMode ? "עודכן!" : "נוסף!");
                setEditMode(false); setCurrentId(null);
                setForm({ title: '', sku: '', price: '', category: 'all', description: '', image: '', features: '', coverage: '', drying: '', standard: '' });
                refresh();
            };

            const fillFromSearch = (data) => {
                setForm(p => ({ ...p, title: data.title, description: data.description, image: data.image }));
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const loadEdit = (p) => {
                setEditMode(true); setCurrentId(p.id);
                setForm({
                    title: p.title||'', sku: p.sku||'', price: p.price||'', category: p.category||'all',
                    description: p.description||'', image: p.image||'',
                    features: (p.features||[]).join(', '),
                    coverage: p.technicalSpecs?.coveragePerM2||'', drying: p.technicalSpecs?.dryingTime||'', standard: p.technicalSpecs?.standard||''
                });
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const deleteP = async (id) => { if(await dbService.deleteProduct(id)) refresh(); };

            return (
                <div className="max-w-7xl mx-auto p-4 md:p-8">
                    <h1 className="text-3xl font-black mb-8 text-teal-400">SabanOS Admin (PB Edition)</h1>
                    <ProductSearch onSelect={fillFromSearch} />
                    
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-1 glass-panel p-6 rounded-xl">
                            <h2 className="text-xl font-bold mb-4 text-teal-400">{editMode ? 'עריכה' : 'הוספה'}</h2>
                            <form onSubmit={handleSubmit} className="space-y-3">
                                <input value={form.title} onChange={e=>setForm({...form, title:e.target.value})} placeholder="שם מוצר" className="input-dark" required/>
                                <div className="grid grid-cols-2 gap-2">
                                    <input value={form.sku} onChange={e=>setForm({...form, sku:e.target.value})} placeholder="מק״ט" className="input-dark" required/>
                                    <input value={form.price} onChange={e=>setForm({...form, price:e.target.value})} placeholder="מחיר" type="number" className="input-dark" required/>
                                </div>
                                <select value={form.category} onChange={e=>setForm({...form, category:e.target.value})} className="input-dark">
                                    <option value="all">כללי</option>
                                    {categories.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                </select>
                                <input value={form.image} onChange={e=>setForm({...form, image:e.target.value})} placeholder="כתובת תמונה (URL)" className="input-dark"/>
                                <textarea value={form.description} onChange={e=>setForm({...form, description:e.target.value})} placeholder="תיאור" className="input-dark h-24"></textarea>
                                
                                <div className="bg-gray-900/50 p-3 rounded border border-gray-700">
                                    <div className="text-xs text-gray-400 mb-2">מפרט טכני</div>
                                    <input value={form.features} onChange={e=>setForm({...form, features:e.target.value})} placeholder="תכונות (מופרד פסיק)" className="input-dark text-xs"/>
                                    <div className="grid grid-cols-3 gap-2">
                                        <input value={form.coverage} onChange={e=>setForm({...form, coverage:e.target.value})} placeholder="כיסוי" className="input-dark text-xs"/>
                                        <input value={form.drying} onChange={e=>setForm({...form, drying:e.target.value})} placeholder="ייבוש" className="input-dark text-xs"/>
                                        <input value={form.standard} onChange={e=>setForm({...form, standard:e.target.value})} placeholder="תקן" className="input-dark text-xs"/>
                                    </div>
                                </div>
                                <button className="btn btn-primary w-full mt-2">{editMode ? 'עדכן' : 'שמור'}</button>
                                {editMode && <button type="button" onClick={()=>{setEditMode(false); setCurrentId(null);}} className="text-xs text-gray-400 mt-2 w-full">ביטול</button>}
                            </form>
                        </div>

                        <div className="lg:col-span-2 space-y-3 max-h-[800px] overflow-y-auto">
                            {products.map(p => (
                                <div key={p.id} className="bg-gray-800 p-3 rounded-xl border border-gray-700 flex gap-4 items-center">
                                    <img src={p.image || 'https://via.placeholder.com/100'} className="w-16 h-16 object-cover rounded bg-gray-900"/>
                                    <div className="flex-1">
                                        <div className="flex justify-between"><h3 className="font-bold">{p.title}</h3><span className="text-teal-400 font-bold">₪{p.price}</span></div>
                                        <div className="text-xs text-gray-400">{p.sku} | {p.category}</div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={()=>loadEdit(p)} className="p-2 bg-gray-700 rounded hover:text-yellow-400"><Icon name="Edit" size={16}/></button>
                                        <button onClick={()=>deleteP(p.id)} className="p-2 bg-gray-700 rounded hover:text-red-400"><Icon name="Trash2" size={16}/></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AdminApp />);
    </script>
</body>
</html>
